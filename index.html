<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EchoFund: The Financial Mirror</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font family -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb; /* Light background */
        }
        .card {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            border-radius: 12px;
        }
        .impact-A, .impact-B {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .impact-B:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(34, 197, 94, 0.5), 0 4px 6px -4px rgba(34, 197, 94, 0.5);
        }
        .impact-A:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(239, 68, 68, 0.5), 0 4px 6px -4px rgba(239, 68, 68, 0.5);
        }
        /* Custom scrollbar for better look */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #3b82f6; border-radius: 3px; }
        ::-webkit-scrollbar-track { background: #e0e7ff; }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8">

    <!-- Main Container -->
    <div class="max-w-4xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-900 flex items-center justify-center">
                <span class="mr-3 text-indigo-600">ðŸ’¡</span> EchoFund
            </h1>
            <p class="text-xl text-gray-600 mt-1">The Financial Mirror & Behavioral Nudge</p>
        </header>

        <!-- User Status & Gamification -->
        <div id="user-status" class="card bg-white p-4 mb-8 border-l-4 border-indigo-500 flex justify-between items-center transition duration-300">
            <div class="flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-indigo-500 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z" />
                </svg>
                <span class="text-gray-700 font-semibold">User ID: <span id="user-id" class="font-mono text-sm text-indigo-500">Loading...</span></span>
            </div>
            <div class="text-right">
                <p class="text-sm text-gray-500">Level: <span id="user-level" class="font-bold text-lg text-indigo-600">1</span></p>
                <p class="text-sm text-gray-500">Score: <span id="user-score" class="font-bold text-lg text-indigo-600">0</span></p>
            </div>
        </div>

        <!-- Input Section -->
        <div id="input-section" class="card bg-white p-6 mb-8">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">What Financial Decision Are You Facing?</h2>
            <textarea id="decision-input" rows="3" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 resize-none" placeholder="e.g., 'I have $500 extra this month. Should I spend it on a new jacket or add it to my emergency fund?'"></textarea>
            <button onclick="analyzeDecision()" id="analyze-button" class="w-full mt-4 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 transform hover:scale-[1.01] focus:outline-none focus:ring-4 focus:ring-indigo-500 focus:ring-opacity-50">
                <span id="button-text">Project Alternate Futures (Ask EchoFund)</span>
                <span id="loading-spinner" class="hidden h-5 w-5 border-2 border-white border-t-transparent rounded-full animate-spin ml-2"></span>
            </button>
        </div>

        <!-- Feedback & Message Display -->
        <div id="message-box" class="hidden p-4 rounded-lg mb-8 text-center" role="alert"></div>

        <!-- Results Section -->
        <div id="results-section" class="hidden">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">The Financial Mirror: Your Alternate Futures</h2>
            <div class="flex flex-col md:flex-row gap-6">

                <!-- Scenario A: The Immediate Decision (Often Negative) -->
                <div id="scenario-a-card" class="impact-A flex-1 card bg-red-50 p-6 border-l-4 border-red-500">
                    <h3 class="text-xl font-bold text-red-600 mb-2 flex items-center">
                        <span class="mr-2">ðŸ›‘</span>
                        <span id="scenario-a-title">Decision Scenario</span>
                    </h3>
                    <p id="scenario-a-outcome" class="text-gray-700 mb-4"></p>
                    <div class="flex justify-between items-center text-red-700 font-semibold">
                        <span>Impact Score:</span>
                        <span id="scenario-a-score" class="text-3xl">0</span>
                    </div>
                </div>

                <!-- Scenario B: The Recommended Nudge (Often Positive) -->
                <div id="scenario-b-card" class="impact-B flex-1 card bg-green-50 p-6 border-l-4 border-green-500">
                    <h3 class="text-xl font-bold text-green-600 mb-2 flex items-center">
                        <span class="mr-2">âœ…</span>
                        <span id="scenario-b-title">EchoFund Nudge</span>
                    </h3>
                    <p id="scenario-b-outcome" class="text-gray-700 mb-4"></p>
                    <div class="flex justify-between items-center text-green-700 font-semibold">
                        <span>Impact Score:</span>
                        <span id="scenario-b-score" class="text-3xl">0</span>
                    </div>
                </div>
            </div>

            <!-- Insight and Choice -->
            <div class="mt-8 card bg-blue-50 p-6 border-l-4 border-blue-500">
                <h3 class="text-xl font-bold text-blue-700 mb-2">EchoFund Insight</h3>
                <p id="ai-insight" class="text-gray-700 mb-4 italic"></p>

                <h3 class="text-xl font-bold text-gray-800 mt-6 mb-3">Which Future Will You Choose?</h3>
                <div class="flex gap-4">
                    <button onclick="commitChoice('A')" class="flex-1 bg-red-500 hover:bg-red-600 text-white font-bold py-2 rounded-lg transition duration-200">
                        Commit to <span id="commit-a-text">Decision</span>
                    </button>
                    <button onclick="commitChoice('B')" class="flex-1 bg-green-500 hover:bg-green-600 text-white font-bold py-2 rounded-lg transition duration-200">
                        Commit to <span id="commit-b-text">Nudge</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase and Application Logic -->
    <script type="module">
        // Mandatory Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Variables (Provided by Canvas Environment)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-echofund-id';
        const firebaseConfig = {
            apiKey: "AIzaSyA0VTSNG9l6SVVtCZjjc8cttqBKbwXyWJA",
            authDomain: "mirrorcap1hackutd25.firebaseapp.com",
            projectId: "mirrorcap1hackutd25",
            storageBucket: "mirrorcap1hackutd25.firebasestorage.app",
            messagingSenderId: "28560693807",
            appId: "1:28560693807:web:a212c632d9ef65d58f44da",
            measurementId: "G-PZK5Y8XR8Y"
        };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const apiKey = "AIzaSyAcnWSzOjJd2nVXMxy7AQ-Aq3GnvUljgpo"; // API key for Gemini

        // Firebase Services
        let app;
        let db;
        let auth;
        let currentUserId = null;
        let isAuthReady = false;

        // User Game State
        let userScore = 0;
        let userLevel = 1;
        const LEVEL_THRESHOLDS = [0, 50, 150, 300]; // Score needed for Level 1, 2, 3, 4...

        // Current Scenario Data (to be used when committing choice)
        let currentScenarios = {};

        // === Utility Functions ===

        function showMessage(type, content) {
            const box = document.getElementById('message-box');
            box.textContent = content;
            box.className = 'p-4 rounded-lg mb-8 text-center';
            box.classList.add('block');
            switch (type) {
                case 'success':
                    box.classList.add('bg-green-100', 'text-green-800');
                    break;
                case 'error':
                    box.classList.add('bg-red-100', 'text-red-800');
                    break;
                case 'info':
                    box.classList.add('bg-blue-100', 'text-blue-800');
                    break;
                default:
                    box.classList.add('bg-gray-100', 'text-gray-800');
            }
            setTimeout(() => {
                box.classList.remove('block');
                box.classList.add('hidden');
            }, 5000);
        }

        function toggleLoading(isLoading) {
            const button = document.getElementById('analyze-button');
            const buttonText = document.getElementById('button-text');
            const spinner = document.getElementById('loading-spinner');
            button.disabled = isLoading;
            if (isLoading) {
                buttonText.textContent = 'Projecting Futures...';
                spinner.classList.remove('hidden');
            } else {
                buttonText.textContent = 'Project Alternate Futures (Ask EchoFund)';
                spinner.classList.add('hidden');
            }
        }

        function calculateLevel(score) {
            for (let i = LEVEL_THRESHOLDS.length - 1; i >= 0; i--) {
                if (score >= LEVEL_THRESHOLDS[i]) {
                    return i + 1;
                }
            }
            return 1;
        }

        function updateUI() {
            document.getElementById('user-id').textContent = currentUserId || 'N/A';
            document.getElementById('user-score').textContent = userScore;
            document.getElementById('user-level').textContent = userLevel;
            document.getElementById('results-section').classList.add('hidden');
        }

        // === Firebase Initialization and State Handling ===

        async function initFirebase() {
            try {
                // setLogLevel('debug'); // Uncomment for debugging
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                await setPersistence(auth, browserLocalPersistence);

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        isAuthReady = true;
                        document.getElementById('user-id').textContent = currentUserId.substring(0, 8) + '...';
                        subscribeToGameState();
                    } else {
                        currentUserId = crypto.randomUUID();
                        isAuthReady = true;
                        document.getElementById('user-id').textContent = currentUserId.substring(0, 8) + ' (Anon)';
                        updateUI();
                        showMessage('info', 'Signed in anonymously. Progress will be saved locally if auth token is unavailable.');
                    }
                });
            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                showMessage('error', `Firebase setup failed: ${error.message}`);
                currentUserId = crypto.randomUUID(); // Fallback for anon user
                isAuthReady = true;
                updateUI();
            }
        }

        function getGameStateRef() {
            if (!currentUserId) return null;
            // Private data storage path: /artifacts/{appId}/users/{userId}/{collectionName}/{documentId}
            return doc(db, 'artifacts', appId, 'users', currentUserId, 'echofund_data', 'state');
        }

        function subscribeToGameState() {
            const docRef = getGameStateRef();
            if (!docRef) return;

            onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    userScore = data.score || 0;
                    userLevel = calculateLevel(userScore);
                    updateUI();
                    showMessage('success', 'Game state loaded from the Financial Cloud.');
                } else {
                    // Initialize state if it doesn't exist
                    userScore = 0;
                    userLevel = 1;
                    updateUI();
                    setDoc(docRef, { score: 0, created: new Date().toISOString() });
                    showMessage('info', 'New EchoFund profile created.');
                }
            }, (error) => {
                console.error("Firestore subscription error:", error);
                showMessage('error', `Error loading state: ${error.message}`);
            });
        }

        async function updateScore(points) {
            if (!isAuthReady || !currentUserId) {
                showMessage('error', 'Authentication not ready. Cannot save progress.');
                return;
            }

            const docRef = getGameStateRef();
            if (!docRef) return;

            userScore += points;
            const newLevel = calculateLevel(userScore);
            const levelUp = newLevel > userLevel;
            userLevel = newLevel;

            try {
                await setDoc(docRef, { score: userScore, updated: new Date().toISOString() }, { merge: true });
                updateUI();
                if (levelUp) {
                    showMessage('success', `Level Up! You are now Level ${userLevel}!`);
                } else {
                    showMessage('success', `Score increased by ${points}. Current Score: ${userScore}`);
                }
            } catch (e) {
                console.error("Error updating document: ", e);
                showMessage('error', 'Error saving score. Please check console.');
            }
        }

        // === Gemini API Logic ===

        /**
         * Calls the Gemini API to get a structured analysis of the user's financial decision.
         */
        async function callGeminiApi(decision) {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            const systemPrompt = `You are EchoFund, an expert behavioral finance AI. Your role is to analyze a user's financial decision and provide two highly distinct alternate futures (scenarios A and B).
            Scenario A must reflect the outcome of the user's immediate decision.
            Scenario B must reflect a financially wiser, nudged alternative (e.g., saving, investing, or delaying a purchase).
            Each scenario must include a detailed narrative (outcome) and a numerical Impact Score (from -100 to +100) reflecting the long-term financial health impact. Negative scores are bad, positive are good.
            Finally, provide a single 'insight' summarizing the comparison.`;

            const userQuery = `My current financial decision is: "${decision}". Analyze this and project two alternate futures (Scenario A: Immediate Action, Scenario B: EchoFund Nudge).`;

            const responseSchema = {
                type: "OBJECT",
                properties: {
                    scenarioA: {
                        type: "OBJECT",
                        description: "The outcome of the user's initial decision.",
                        properties: {
                            title: { "type": "STRING", "description": "A short title for the scenario (e.g., 'The Immediate Purchase')." },
                            outcome: { "type": "STRING", "description": "A detailed, behavioral-focused narrative of the financial future." },
                            impactScore: { "type": "INTEGER", "description": "The financial impact score (-100 to +100)." }
                        },
                        required: ["title", "outcome", "impactScore"]
                    },
                    scenarioB: {
                        type: "OBJECT",
                        description: "The outcome of the financially nudged decision.",
                        properties: {
                            title: { "type": "STRING", "description": "A short title for the nudge (e.g., 'The Smart Investment')." },
                            outcome: { "type": "STRING", "description": "A detailed, behavioral-focused narrative of the financial future." },
                            impactScore: { "type": "INTEGER", "description": "The financial impact score (-100 to +100)." }
                        },
                        required: ["title", "outcome", "impactScore"]
                    },
                    insight: { "type": "STRING", "description": "A concise summary comparing the two scenarios." }
                },
                required: ["scenarioA", "scenarioB", "insight"]
            };

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: responseSchema
                },
            };

            let attempts = 0;
            const maxAttempts = 3;

            while (attempts < maxAttempts) {
                attempts++;
                const delay = Math.pow(2, attempts - 1) * 1000; // Exponential backoff (1s, 2s, 4s)

                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.status === 429 && attempts < maxAttempts) {
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue;
                    }

                    if (!response.ok) {
                        throw new Error(`API returned status ${response.status}: ${response.statusText}`);
                    }

                    const result = await response.json();
                    const jsonString = result.candidates?.[0]?.content?.parts?.[0]?.text;

                    if (!jsonString) {
                        throw new Error("Gemini API returned no content.");
                    }

                    // Remove markdown backticks if the model wraps the JSON string
                    const cleanJsonString = jsonString.replace(/```json\n|```/g, '').trim();

                    return JSON.parse(cleanJsonString);

                } catch (error) {
                    console.error(`Attempt ${attempts} failed:`, error);
                    if (attempts === maxAttempts) {
                        throw new Error(`Failed to process request after ${maxAttempts} attempts.`);
                    }
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        // === Main Application Functions ===

        window.analyzeDecision = async function() {
            const decisionInput = document.getElementById('decision-input').value.trim();
            document.getElementById('results-section').classList.add('hidden');
            document.getElementById('message-box').classList.add('hidden');

            if (!decisionInput) {
                showMessage('error', 'Please describe your financial decision first!');
                return;
            }

            toggleLoading(true);

            try {
                const analysis = await callGeminiApi(decisionInput);
                currentScenarios = analysis;

                // Update Scenario A
                document.getElementById('scenario-a-title').textContent = analysis.scenarioA.title;
                document.getElementById('scenario-a-outcome').textContent = analysis.scenarioA.outcome;
                document.getElementById('scenario-a-score').textContent = analysis.scenarioA.impactScore;
                document.getElementById('commit-a-text').textContent = analysis.scenarioA.title;

                // Update Scenario B (Nudge)
                document.getElementById('scenario-b-title').textContent = analysis.scenarioB.title;
                document.getElementById('scenario-b-outcome').textContent = analysis.scenarioB.outcome;
                document.getElementById('scenario-b-score').textContent = analysis.scenarioB.impactScore;
                document.getElementById('commit-b-text').textContent = analysis.scenarioB.title;

                // Update Insight
                document.getElementById('ai-insight').textContent = analysis.insight;

                document.getElementById('results-section').classList.remove('hidden');
                showMessage('info', 'EchoFund has successfully projected your alternate futures! Now, make your choice.');

            } catch (error) {
                console.error("Analysis Error:", error);
                showMessage('error', `Analysis failed. Check the console for details. (Error: ${error.message})`);
            } finally {
                toggleLoading(false);
            }
        }

        window.commitChoice = function(choice) {
            if (!currentScenarios || (!currentScenarios.scenarioA && !currentScenarios.scenarioB)) {
                showMessage('error', 'Please run a projection before committing a choice.');
                return;
            }

            let scoreEarned = 0;
            let choiceText = "";
            let impactScore = 0;

            if (choice === 'A') {
                impactScore = currentScenarios.scenarioA.impactScore;
                choiceText = currentScenarios.scenarioA.title;
            } else {
                impactScore = currentScenarios.scenarioB.impactScore;
                choiceText = currentScenarios.scenarioB.title;
            }

            // Gamification Logic: Score earned is 1 point for every 5 points of Impact Score
            scoreEarned = Math.max(0, Math.floor(impactScore / 5));

            if (scoreEarned > 0) {
                updateScore(scoreEarned);
                showMessage('success', `You committed to the ${choiceText} choice, earning ${scoreEarned} score points! Keep growing your financial mirror.`);
            } else {
                showMessage('info', `You committed to the ${choiceText} choice. While the Impact Score was low, every choice is a learning experience.`);
            }

            // Reset UI for next decision
            document.getElementById('decision-input').value = '';
            document.getElementById('results-section').classList.add('hidden');
        }

        // Initialize everything when the window loads
        window.onload = initFirebase;
    </script>
</body>
</html>